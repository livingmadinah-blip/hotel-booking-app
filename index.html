<script>
const API = "https://script.google.com/macros/s/AKfycbw6wpte6_x4CCFD6adhdkh7Rsy9TWdje3sghYkl6TdY_sYqnS_u4Os7sciS6kGu_YxC/exec"; // your deployed Web App URL
let editId = null; // tracks current booking being edited
let bookings = []; // store fetched bookings

// Save new or updated booking
function save() {
  const data = {
    action: editId ? "update" : "create",
    id: editId,
    guest: document.getElementById("guest").value,
    room: document.getElementById("room").value,
    checkin: document.getElementById("checkin").value,
    checkout: document.getElementById("checkout").value,
    rate: Number(document.getElementById("rate").value)
  };

  // Basic validation
  if (!data.guest || !data.room || !data.checkin || !data.checkout || !data.rate) {
    alert("Please fill all fields correctly.");
    return;
  }

  fetch(API, {
    method: "POST",
    body: JSON.stringify(data)
  })
  .then(res => res.json())
  .then(res => {
    alert(res.message || res.status);
    clearForm();
    loadBookings();
  })
  .catch(err => alert("Error: " + err));
}

// Load all bookings from the sheet
function loadBookings() {
  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "list" })
  })
  .then(res => res.json())
  .then(rows => {
    bookings = rows;
    const list = document.getElementById("list");
    list.innerHTML = "";
    rows.forEach(r => {
      list.innerHTML += `
        <div class="card">
          <b>${r[1]}</b> – Room ${r[2]}<br>
          ${formatDate(r[3])} → ${formatDate(r[4])}<br>
          Rate: ${r[6]} | Total: ${r[7]}<br>
          <button onclick="editBooking('${r[0]}')">Edit</button>
          <button onclick="deleteBooking('${r[0]}')">Delete</button>
        </div>`;
    });
  });
}

// Edit booking: fill the form with selected booking
function editBooking(id) {
  const b = bookings.find(r => r[0] === id);
  if (!b) return;

  editId = b[0];
  document.getElementById("guest").value = b[1];
  document.getElementById("room").value = b[2];
  document.getElementById("checkin").value = toInputDate(b[3]);
  document.getElementById("checkout").value = toInputDate(b[4]);
  document.getElementById("rate").value = b[6];
}

// Delete booking
function deleteBooking(id) {
  if (!confirm("Are you sure you want to delete this booking?")) return;

  fetch(API, {
    method: "POST",
    body: JSON.stringify({ action: "delete", id })
  })
  .then(() => loadBookings());
}

// Clear form after saving or canceling
function clearForm() {
  editId = null;
  document.getElementById("guest").value = "";
  document.getElementById("room").value = "";
  document.getElementById("checkin").value = "";
  document.getElementById("checkout").value = "";
  document.getElementById("rate").value = "";
}

// Helpers to format dates
function formatDate(d) {
  return new Date(d).toLocaleDateString();
}

function toInputDate(d) {
  return new Date(d).toISOString().split("T")[0];
}

// Initial load of bookings
loadBookings();
</script>
